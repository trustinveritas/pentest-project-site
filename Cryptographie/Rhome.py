"""
Author      : AnyGuy
Date        : 2023-05-29

Title       : Rhome.py

Description : HackTheBox - Rhome
    
    - Crypto Challenge
    - Diffie-Hellman key exchange protocol

"""

# Import Libraries
from sympy import discrete_log, Mod
from Crypto.Util.number import long_to_bytes
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad
from hashlib import sha256

# Values from the script
p = 71934106223357065089517859022001720012805514470517747169040663658406946046280656156000529521741851380897750286267777889090258222189719333456487465885217705067436936599
g = 4526609716231232309562594636878965191961307271082670612714122189669326367792246612844884957366653456766731447468010088687938784475041206906421432529471512869456056614
A = 13059782810279307518360491492775405678405891374496465488700714798417624746133374152974740310767434370305912733252436071214856281022937140620554267827530633575388534713
B = 68298419573655735526470094342381051265132255477411694982447764096434089190961769112930303999487380890082703760278209500018616913360032510492149282821507381402559104657
ct = bytes.fromhex("ac6bd415fa28ab45945f1605c336f115b0bc3242f26326d6af538e9de48aa761")

# Discrete logarithm to calculate 'a'
a = discrete_log(Mod(A, p), Mod(g, p), p)

# Calculate ss
ss = pow(B, a, p)

# Calculating the key
key = sha256(long_to_bytes(ss)).digest()[:16]

# Encrypting the text
cipher = AES.new(key, AES.MODE_ECB)
pt = unpad(cipher.decrypt(ct), 16)

print("Flag:", pt.decode())