import json
import datetime
import sys

if len(sys.argv) == 3:
    access_log = open(sys.argv[1], 'r')
    forensics_log = open(sys.argv[2], 'r')
else:
    access_log = open('access.log', 'r')
    forensics_log = open('forensics.json', 'r')

# Match log file entries using the unique request ID
output_json = []
for access_line in access_log:
  access_data = access_line.split(' ')
  request_id = access_data[0]
  for forensics_line in forensics_log:
    forensics_data = json.loads(forensics_line)
    if forensics_data['requestId'] == request_id:
      # Write a JSON object to STDOUT or into the file output.json for each identified request in the file access.log
      output_json.append({
        'requestId': request_id,
        'remoteAddress': access_data[1],
        'timestamp': datetime.datetime.strptime(access_data[4], '%d/%m/%Y:%H:%M:%S').isoformat(),
        'method': access_data[5],
        'url': access_data[6],
        'version': access_data[7],
        'responseCode': access_data[8],
        'responseSize': access_data[9],
        'requestHeaders': forensics_data['headers']
      })

# Convert headers into a dictionary of lists
for json_object in output_json:
  headers = json_object['requestHeaders'].split('\n')
  json_object['requestHeaders'] = {}
  for header in headers:
    header_data = header.split(':')
    if header_data[0] in json_object['requestHeaders']:
      json_object['requestHeaders'][header_data[0]].append(header_data[1])
    else:
      json_object['requestHeaders'][header_data[0]] = [header_data[1]]

# Write output to file
output_file = open('output.json', 'w')
for json_object in output_json:
  output_file.write(json.dumps(json_object) + '\n')
output_file.close()